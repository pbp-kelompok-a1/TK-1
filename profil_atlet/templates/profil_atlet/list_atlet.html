{% extends 'base.html' %}
{% load static %}
{% block content %}

{% include 'navbar.html' %}

<main class="container mx-auto px-4 py-8">

<div class="mb-10 p-8 bg-paraworld-blue rounded-xl text-white shadow-xl bg-gradient-to-r from-paraworld-blue to-blue-400">
    <h1 class="text-4xl font-bold mb-2">Athletes Gallery</h1>
    <p class="text-lg opacity-90">Celebrating the remarkable stories of Paralympic athletes whose determination and passion transcend limits and inspire millions around the globe.</p>
</div>

{% if user.is_authenticated and user.is_superuser %}
    <div class="mb-6">
        <button type="button" id="btn-tambah-atlet"
            class="inline-block px-5 py-3 bg-green-600 text-white rounded-lg font-semibold shadow-md hover:bg-green-700 transition-all duration-300 transform hover:scale-105">
        + Add New Athlete Profile
    </button>
    </div>
{% endif %}


<div id="atlet-grid-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
</div>
</main> 

{% endblock content %} {% block javascript %} 
<script>
    // url utk ambil data JSON
    const DATA_URL = "{% url 'profil_atlet:show_json_atlet' %}";
    
    // variabel utk save hak akses (untuk tombol detail, edit, delete)
    const IS_AUTHENTICATED = "{{ user.is_authenticated|yesno:'true,false' }}" === "true";
    const IS_SUPERUSER = "{{ user.is_superuser|yesno:'true,false' }}" === "true";

    // fungsi utk buat 1 card atlet 
    function createAthleteCard(atlet) {
        
        // HTML untuk Medali
        let medalHtml = '';
        if (atlet.total_medals > 0) {
            medalHtml = `
            <div class="mb-5">
                <div class="flex flex-wrap gap-2">
                    ${atlet.gold_count > 0 ? `
                    <span class="flex items-center bg-yellow-400 text-yellow-900 text-sm font-bold px-3 py-1 rounded-full shadow">
                        <span class="mr-1.5">ðŸ¥‡</span> ${atlet.gold_count}
                    </span>` : ''}
                    
                    ${atlet.silver_count > 0 ? `
                    <span class="flex items-center bg-gray-300 text-gray-800 text-sm font-bold px-3 py-1 rounded-full shadow">
                        <span class="mr-1.5">ðŸ¥ˆ</span> ${atlet.silver_count}
                    </span>` : ''}
                    
                    ${atlet.bronze_count > 0 ? `
                    <span class="flex items-center bg-yellow-600/70 text-white text-sm font-bold px-3 py-1 rounded-full shadow">
                        <span class="mr-1.5">ðŸ¥‰</span> ${atlet.bronze_count}
                    </span>` : ''}
                </div>
            </div>`;
        } else {
            medalHtml = '<div class="mb-5 h-10"></div>'; // placehorlder agar tinggi card sama
        }

        // HTML untuk Tombol Detail
        let buttonHtml = '';
        if (IS_AUTHENTICATED) {
            const detailUrl = `/atlet/${atlet.pk}/`; 
            buttonHtml = `
            <a href="${detailUrl}" class="block w-full text-center px-4 py-3 bg-paraworld-dark text-white rounded-lg font-semibold hover:bg-gray-700 transition-colors">
                View Details
            </a>`;
        } else {
            buttonHtml = '<p class="text-sm text-gray-500 italic text-center py-3">Login to view details.</p>';
        }

        // HTML untuk Panel Admin
        let adminPanelHtml = '';
        if (IS_SUPERUSER) {
            const updateUrl = `/atlet/update/${atlet.pk}/`;
            const deleteUrl = `/atlet/delete/${atlet.pk}/`;
            adminPanelHtml = `
            <div class="mt-4 pt-4 border-t border-gray-200 text-xs">
                <div class="flex justify-between items-center">
                    <div>
                        ${atlet.is_visible ? 
                        '<span class="font-medium bg-green-100 text-green-700 px-2 py-1 rounded-full">Visible</span>' : 
                        '<span class="font-medium bg-red-100 text-red-700 px-2 py-1 rounded-full">Hidden</span>'}
                    </div>
                    <div class="flex space-x-2">
                        <a href="${updateUrl}" class="font-medium bg-yellow-400 text-yellow-900 px-3 py-1 rounded-md hover:bg-yellow-500">Edit</a>
                        <button type="button" 
                                data-pk="${atlet.pk}" 
                                data-name="${atlet.name}" 
                                class="btn-delete-atlet font-medium bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600">
                            Delete
                        </button>
                    </div>
                </div>
            </div>`;
        }

        // merge semua HTML jd 1 card
        return `
        <div class="bg-white rounded-xl shadow-xl transition-all duration-300 transform hover:scale-105 border-t-8 border-paraworld-blue">
            <div class="p-6">
                <div class="mb-3">
                    <span class="text-xs font-bold uppercase text-paraworld-blue tracking-wider">${atlet.discipline}</span>
                </div>
                <h5 class="text-2xl font-bold text-paraworld-dark mb-3">
                    ${atlet.name}
                    ${atlet.short_name ? `<span class="text-lg text-gray-500 font-medium">(${atlet.short_name})</span>` : ''}
                </h5>
                <div class="flex items-center text-gray-600 mb-5">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                    </svg>
                    <span>${atlet.country}</span>
                </div>
                ${medalHtml}
                ${buttonHtml}
                ${adminPanelHtml}
            </div>
        </div>
        `;
    }

    // func utk ambil data (AJAX) dan show all card
    async function loadAthleteData() {
        const container = document.getElementById('atlet-grid-container');
        container.innerHTML = '<p class="text-gray-500 col-span-3 text-center">Loading athlete data...</p>'; 

        try {
            // ambil data dari URL
            const response = await fetch(DATA_URL);
            const data = await response.json();

            // cek jika tidak ada data
            if (data.length === 0) {
                container.innerHTML = '<p class="text-gray-700 col-span-3 text-center">No athlete data available.</p>';
                return;
            }

            // ubah tiap item data menjadi kartu HTML
            let allCardsHtml = '';
            data.forEach(atlet => {
                allCardsHtml += createAthleteCard(atlet);
            });

            // masukkan semua card ke dlm container
            container.innerHTML = allCardsHtml;

        } catch (error) {
            console.error('Error fetching data:', error);
            container.innerHTML = '<p class="text-red-500 col-span-3 text-center">Failed to load data. Try to refreshing page.</p>';
        }
    }

    // fungsi utk memuat dan menampilkan form tambah atlet
    async function openCreateModal() {
        try {
            const response = await fetch("{% url 'profil_atlet:create_atlet' %}");
            let formHtml = await response.text();
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(formHtml, 'text/html');
            const formElement = doc.querySelector('#atlet-form'); 

            if (!formElement) {
                showToast("Failed to load form.", true);
                return;
            }

            const originalButtons = formElement.querySelector('#form-buttons-container');

            if (originalButtons) {
                originalButtons.remove();
            }

            // HTML untuk modal
            const modalBodyHtml = `
                ${formElement.outerHTML} <div class="p-6 bg-gray-50 border-t flex justify-end gap-3">
                    <button type="button" onclick="hideModal()" class="px-5 py-2 rounded-lg bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300">
                        Cancel
                    </button>
                    <button type="submit" form="atlet-form" class="px-5 py-2 rounded-lg bg-green-600 text-white font-semibold hover:bg-green-700">
                        Save Athlete
                    </button>
                </div>
            `;
            // show modal
            showModal("Add New Athlete", modalBodyHtml);

        } catch (error) {
            console.error('Error fetching form:', error);
            showToast("Failed to open modal.", true);
        }
    }

    // fungsi handler submit form via AJAX
    async function handleCreateFormSubmit(event) {
        // cek apakah ini form yang benar
        if (event.target.id !== 'atlet-form') {
            return; 
        }
        
        event.preventDefault(); 
        
        const form = event.target;
        const formData = new FormData(form);

        try {
            const response = await fetch("{% url 'profil_atlet:create_atlet_ajax' %}", {
                method: "POST",
                body: formData,
                headers: {}
            });

            const result = await response.json();

            if (result.status === "success") {
                hideModal(); // hide modal
                showToast(result.message, false); // show toast sukses(warna ijo)
                loadAthleteData(); // load ulang data atlet di halaman
            } else {
                // show error
                console.error("Form errors:", result.errors);
                showToast(result.message || "The form is invalid.", true);
            }

        } catch (error) {
            console.error('Error submitting form:', error);
            showToast("An error occurred. Please try again.", true);
        }
    }

    // func utk buka modal utk confirm delete
    function openDeleteModal(pk, name) {
        // HTML untuk body modal
        const modalBodyHtml = `
            <p class="text-gray-600 mb-6">
                Are you sure you want to delete this athlete?: 
                <strong class="text-paraworld-dark">${name}</strong>?
            </p>
            <div class="p-6 bg-gray-50 border-t flex justify-end gap-3 -m-6 mt-6">
                <button type="button" onclick="hideModal()" class="px-5 py-2 rounded-lg bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300">
                    Cancel
                </button>
                <button type="button" id="confirm-delete-btn" data-pk="${pk}" class="px-5 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700">
                    Yes, Delete
                </button>
            </div>
        `;

        // show modal (fungsi showModal ada di base.html)
        showModal("Confirm Athlete Deletion", modalBodyHtml);
    }

    // func utk kirim request delete via AJAX
    async function handleDelete(pk) {
        try {
            // panggik URL delete-ajax 
            const response = await fetch(`/atlet/delete-ajax/${pk}/`, {
                method: "DELETE",
            });

            const result = await response.json();

            if (result.status === "success") {
                hideModal(); // close modal
                showToast(result.message, false); 
                loadAthleteData();
            } else {
                hideModal();
                showToast(result.message, true);
            }

        } catch (error) {
            hideModal();
            showToast("Failed to delete data.", true);
        }
    }

    // run func saat halaman selesai diload
    document.addEventListener('DOMContentLoaded', () => {
        loadAthleteData();
    
        // listener utk tombol "Add Athlete"
        const btnTambah = document.getElementById('btn-tambah-atlet');
        if (btnTambah) { 
            btnTambah.addEventListener('click', openCreateModal);
        }
    
        // listener untuk form submit di modal
        document.addEventListener('submit', handleCreateFormSubmit);
    });

    document.addEventListener('click', (event) => {
        // cek apakah yang diklik tombol delete di card
        if (event.target.classList.contains('btn-delete-atlet')) {
            const pk = event.target.dataset.pk;
            const name = event.target.dataset.name;
            openDeleteModal(pk, name); // buka modal tuk confirm
        }
        // cek apakah yang diklik tombol "Yes, Delete" di dalam modal
        if (event.target.id === 'confirm-delete-btn') {
            const pk = event.target.dataset.pk;
            handleDelete(pk); 
        }
    });

</script>
{% endblock javascript %}